// === i18n ===
const i18n = {
  de: {
    'nav.home': 'Start',
    'nav.menu': 'Speisekarte',
    'nav.delivery': 'Lieferservice',
    'nav.hours': 'Öffnungszeiten',
    'nav.reservation': 'Reservierung',
    'nav.contact': 'Kontakt',
    'cart.title_short': 'Warenkorb',
    'hero.headline1': 'Benvenuti',
    'hero.headline2': '– willkommen im',
    'hero.sub': 'Frische Pizza, Pasta & Antipasti – authentisch italienisch. Reservieren oder direkt online bestellen.',
    'cta.view_menu': 'Speisekarte ansehen',
    'cta.order_now': 'Jetzt bestellen',
    'menu.title': 'Speisekarte',
    'delivery.title': 'Lieferservice',
    'delivery.point1': 'Lieferung ab 15 € Bestellwert • Liefergebühr 3,50 € • Frei ab 35 €',
    'delivery.point2': 'Abholung jederzeit möglich – 10% Rabatt bei Abholung',
    'delivery.point3': 'Durchschnittliche Lieferzeit: 30–45 Minuten',
    'delivery.pickup': 'Abholung',
    'delivery.delivery': 'Lieferung',
    'form.name': 'Name',
    'form.name_placeholder': 'Mario Rossi',
    'form.phone': 'Telefon',
    'form.phone_placeholder': '+49 171 1234567',
    'form.email': 'E‑Mail',
    'form.email_placeholder': 'mario@example.com',
    'form.street': 'Straße & Nr.',
    'form.street_placeholder': 'Via Roma 1',
    'form.zip': 'PLZ',
    'form.zip_placeholder': '70173',
    'form.city': 'Stadt',
    'form.city_placeholder': 'Stuttgart',
    'form.notes': 'Hinweise (Klingel, Etage, Allergien)',
    'form.notes_placeholder': 'z. B. 3. OG, bitte klingeln bei Rossi',
    'form.message': 'Nachricht',
    'form.message_placeholder': 'Ihre Nachricht...',
    'form.date': 'Datum',
    'form.time': 'Uhrzeit',
    'form.guests': 'Anzahl Personen',
    'summary.title': 'Ihre Bestellung',
    'summary.subtotal': 'Zwischensumme',
    'summary.pickup_discount': 'Abholrabatt (10%)',
    'summary.delivery_fee': 'Liefergebühr',
    'summary.total': 'Gesamt',
    'summary.min_note': 'Mindestbestellwert für Lieferung: 15,00 €',
    'summary.clear': 'Warenkorb leeren',
    'summary.place': 'Bestellung abschicken',
    'drawer.to_delivery': 'Zur Bestellung',
    'hours.title': 'Öffnungszeiten',
    'hours.tue_fri': 'Di – Fr',
    'hours.sat_sun': 'Sa – So',
    'hours.mon': 'Montag Ruhetag',
    'reservation.title': 'Reservierung',
    'reservation.cta': 'Jetzt reservieren',
    'contact.title': 'Kontakt',
    'contact.cta': 'Absenden',
    'contact.map_placeholder': 'Hier könnte eine Google‑Maps‑Einbettung mit Ihrer Adresse stehen.',
    'footer.rights': 'Alle Rechte vorbehalten.',
    // messages
    'msg.contact_success': 'Grazie mille! Ihre Nachricht ist angekommen.',
    'msg.reservation_success': 'Grazie mille! Ihre Reservierung ist eingegangen.',
    'msg.added': 'hinzugefügt',
    'msg.min_order': 'Für eine Lieferung sind mindestens 15,00 € erforderlich.',
    'msg.order_mail_subject': 'Neue Online-Bestellung',
    'msg.order_mail_body': 'Bestellung'
  },
  en: {
    'nav.home': 'Home',
    'nav.menu': 'Menu',
    'nav.delivery': 'Delivery',
    'nav.hours': 'Hours',
    'nav.reservation': 'Reservation',
    'nav.contact': 'Contact',
    'cart.title_short': 'Cart',
    'hero.headline1': 'Benvenuti',
    'hero.headline2': '– welcome to',
    'hero.sub': 'Fresh pizza, pasta & antipasti – authentically Italian. Book a table or order online.',
    'cta.view_menu': 'View menu',
    'cta.order_now': 'Order now',
    'menu.title': 'Menu',
    'delivery.title': 'Delivery',
    'delivery.point1': 'Delivery from €15 • Delivery fee €3.50 • Free from €35',
    'delivery.point2': 'Pickup available anytime – 10% pickup discount',
    'delivery.point3': 'Average delivery time: 30–45 minutes',
    'delivery.pickup': 'Pickup',
    'delivery.delivery': 'Delivery',
    'form.name': 'Name',
    'form.name_placeholder': 'Mario Rossi',
    'form.phone': 'Phone',
    'form.phone_placeholder': '+49 171 1234567',
    'form.email': 'Email',
    'form.email_placeholder': 'mario@example.com',
    'form.street': 'Street & No.',
    'form.street_placeholder': 'Via Roma 1',
    'form.zip': 'ZIP',
    'form.zip_placeholder': '70173',
    'form.city': 'City',
    'form.city_placeholder': 'Stuttgart',
    'form.notes': 'Notes (doorbell, floor, allergies)',
    'form.notes_placeholder': 'e.g. 3rd floor, ring Rossi',
    'form.message': 'Message',
    'form.message_placeholder': 'Your message...',
    'form.date': 'Date',
    'form.time': 'Time',
    'form.guests': 'Guests',
    'summary.title': 'Your order',
    'summary.subtotal': 'Subtotal',
    'summary.pickup_discount': 'Pickup discount (10%)',
    'summary.delivery_fee': 'Delivery fee',
    'summary.total': 'Total',
    'summary.min_note': 'Minimum order for delivery: €15.00',
    'summary.clear': 'Clear cart',
    'summary.place': 'Place order',
    'drawer.to_delivery': 'Proceed to checkout',
    'hours.title': 'Opening hours',
    'hours.tue_fri': 'Tue – Fri',
    'hours.sat_sun': 'Sat – Sun',
    'hours.mon': 'Closed on Mondays',
    'reservation.title': 'Reservation',
    'reservation.cta': 'Reserve now',
    'contact.title': 'Contact',
    'contact.cta': 'Send',
    'contact.map_placeholder': 'A Google Maps embed with your address can be placed here.',
    'footer.rights': 'All rights reserved.',
    'msg.contact_success': 'Grazie mille! Your message has been received.',
    'msg.reservation_success': 'Grazie mille! Your reservation has been received.',
    'msg.added': 'added',
    'msg.min_order': 'Delivery requires a minimum of €15.00.',
    'msg.order_mail_subject': 'New online order',
    'msg.order_mail_body': 'Order'
  },
  it: {
    'nav.home': 'Home',
    'nav.menu': 'Menu',
    'nav.delivery': 'Consegna',
    'nav.hours': 'Orari',
    'nav.reservation': 'Prenotazione',
    'nav.contact': 'Contatto',
    'cart.title_short': 'Carrello',
    'hero.headline1': 'Benvenuti',
    'hero.headline2': '– al',
    'hero.sub': 'Pizza, pasta e antipasti freschi – autentico italiano. Prenota o ordina online.',
    'cta.view_menu': 'Vedi menu',
    'cta.order_now': 'Ordina ora',
    'menu.title': 'Menu',
    'delivery.title': 'Consegna a domicilio',
    'delivery.point1': 'Consegna da €15 • Spese di consegna €3,50 • Gratis da €35',
    'delivery.point2': 'Ritiro sempre possibile – 10% di sconto sul ritiro',
    'delivery.point3': 'Tempo medio di consegna: 30–45 minuti',
    'delivery.pickup': 'Ritiro',
    'delivery.delivery': 'Consegna',
    'form.name': 'Nome',
    'form.name_placeholder': 'Mario Rossi',
    'form.phone': 'Telefono',
    'form.phone_placeholder': '+49 171 1234567',
    'form.email': 'Email',
    'form.email_placeholder': 'mario@example.com',
    'form.street': 'Via e n.',
    'form.street_placeholder': 'Via Roma 1',
    'form.zip': 'CAP',
    'form.zip_placeholder': '70173',
    'form.city': 'Città',
    'form.city_placeholder': 'Stoccarda',
    'form.notes': 'Note (campanello, piano, allergie)',
    'form.notes_placeholder': 'es. 3° piano, citofono Rossi',
    'form.message': 'Messaggio',
    'form.message_placeholder': 'Il tuo messaggio...',
    'form.date': 'Data',
    'form.time': 'Ora',
    'form.guests': 'Ospiti',
    'summary.title': 'Il tuo ordine',
    'summary.subtotal': 'Subtotale',
    'summary.pickup_discount': 'Sconto ritiro (10%)',
    'summary.delivery_fee': 'Spese di consegna',
    'summary.total': 'Totale',
    'summary.min_note': 'Ordine minimo per la consegna: €15,00',
    'summary.clear': 'Svuota carrello',
    'summary.place': 'Invia ordine',
    'drawer.to_delivery': 'Vai al checkout',
    'hours.title': 'Orari di apertura',
    'hours.tue_fri': 'Mar – Ven',
    'hours.sat_sun': 'Sab – Dom',
    'hours.mon': 'Chiuso il lunedì',
    'reservation.title': 'Prenotazione',
    'reservation.cta': 'Prenota ora',
    'contact.title': 'Contatto',
    'contact.cta': 'Invia',
    'contact.map_placeholder': 'Qui è possibile inserire una mappa di Google con il vostro indirizzo.',
    'footer.rights': 'Tutti i diritti riservati.',
    'msg.contact_success': 'Grazie mille! Il tuo messaggio è stato ricevuto.',
    'msg.reservation_success': 'Grazie mille! La tua prenotazione è stata ricevuta.',
    'msg.added': 'aggiunto',
    'msg.min_order': 'Per la consegna è richiesto un minimo di €15,00.',
    'msg.order_mail_subject': 'Nuovo ordine online',
    'msg.order_mail_body': 'Ordine'
  }
};

function t(key){
  const lang = state.lang;
  return i18n[lang]?.[key] ?? i18n['de'][key] ?? key;
}

function applyI18n(){
  document.documentElement.lang = state.lang;
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    el.textContent = t(key);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
    const key = el.getAttribute('data-i18n-placeholder');
    el.setAttribute('placeholder', t(key));
  });
  // Update dynamic numbers currency
  updateTotals();
}

// === State ===
const state = {
  lang: localStorage.getItem('lang') || 'de',
  cart: JSON.parse(localStorage.getItem('cart') || '[]'),
  orderType: 'pickup' // 'pickup' or 'delivery'
};

// === Utilities ===
const fmtCurrency = (n) => new Intl.NumberFormat(state.lang === 'en' ? 'en-IE' : state.lang, {style:'currency',currency:'EUR'}).format(n);
const byId = (id) => document.getElementById(id);

// === Menu data ===
const MENU = [
  {
    id: 'caprese',
    name: {de:'Insalata Caprese', en:'Insalata Caprese', it:'Insalata Caprese'},
    desc: {de:'Tomate, Mozzarella, Basilikum', en:'Tomato, mozzarella, basil', it:'Pomodoro, mozzarella, basilico'},
    price: 7.00,
    cat: 'antipasti'
  },
  {
    id: 'bruschetta',
    name: {de:'Bruschetta', en:'Bruschetta', it:'Bruschetta'},
    desc: {de:'Knuspriges Brot, Tomaten, Knoblauch', en:'Crispy bread, tomatoes, garlic', it:'Pane croccante, pomodori, aglio'},
    price: 5.50,
    cat: 'antipasti'
  },
  {
    id: 'garlicbread',
    name: {de:'Knoblauchbrot', en:'Garlic bread', it:'Pane all’aglio'},
    desc: {de:'Hausgemacht, Kräuterbutter', en:'Homemade, herb butter', it:'Fatto in casa, burro alle erbe'},
    price: 4.00,
    cat: 'antipasti'
  },
  {
    id: 'margherita',
    name: {de:'Pizza Margherita', en:'Pizza Margherita', it:'Pizza Margherita'},
    desc: {de:'Tomate, Mozzarella, Basilikum', en:'Tomato, mozzarella, basil', it:'Pomodoro, mozzarella, basilico'},
    price: 8.50,
    cat: 'main'
  },
  {
    id: 'bolognese',
    name: {de:'Spaghetti Bolognese', en:'Spaghetti Bolognese', it:'Spaghetti alla bolognese'},
    desc: {de:'Ragù di manzo, Parmesan', en:'Beef ragù, parmesan', it:'Ragù di manzo, parmigiano'},
    price: 9.90,
    cat: 'main'
  },
  {
    id: 'pollo',
    name: {de:'Pollo alla Griglia', en:'Grilled Chicken', it:'Pollo alla griglia'},
    desc: {de:'Hähnchenbrust, mediterranes Gemüse', en:'Chicken breast, mediterranean vegetables', it:'Petto di pollo, verdure mediterranee'},
    price: 12.50,
    cat: 'main'
  },
  {
    id: 'tiramisu',
    name: {de:'Tiramisù', en:'Tiramisù', it:'Tiramisù'},
    desc: {de:'Hausgemacht', en:'Homemade', it:'Fatto in casa'},
    price: 6.00,
    cat: 'dolci'
  },
  {
    id: 'gelato',
    name: {de:'Gelato Misto', en:'Mixed gelato', it:'Gelato misto'},
    desc: {de:'Drei Sorten nach Wahl', en:'Three scoops of choice', it:'Tre gusti a scelta'},
    price: 4.50,
    cat: 'dolci'
  },
  {
    id: 'pannacotta',
    name: {de:'Panna Cotta', en:'Panna Cotta', it:'Panna Cotta'},
    desc: {de:'mit Beerenspiegel', en:'with berry coulis', it:'con coulis ai frutti di bosco'},
    price: 5.00,
    cat: 'dolci'
  }
];

// === Render Menu ===
function renderMenu(){
  const grid = byId('menuGrid');
  grid.innerHTML = '';
  MENU.forEach(item=>{
    const card = document.createElement('article');
    card.className = 'menu-card card';
    card.innerHTML = `
      <h3>${item.name[state.lang]}</h3>
      <p>${item.desc[state.lang]}</p>
      <div class="row">
        <span class="price">${fmtCurrency(item.price)}</span>
        <button class="btn btn--ghost add" data-id="${item.id}">+ ${state.lang==='de'?'Hinzufügen':state.lang==='it'?'Aggiungi':'Add'}</button>
      </div>
    `;
    grid.appendChild(card);
  });

  grid.querySelectorAll('.add').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = e.currentTarget.getAttribute('data-id');
      addToCart(id);
      // small toast
      e.currentTarget.textContent = '✓ ' + (state.lang==='de'?'Hinzugefügt':state.lang==='it'?'Aggiunto':'Added');
      setTimeout(()=>{
        e.currentTarget.textContent = '+ ' + (state.lang==='de'?'Hinzufügen':state.lang==='it'?'Aggiungi':'Add');
      }, 800);
    });
  });
}

// === Cart ===
function addToCart(id){
  const item = MENU.find(m=>m.id===id);
  const existing = state.cart.find(ci=>ci.id===id);
  if(existing){ existing.qty += 1; }
  else{ state.cart.push({id, qty:1}); }
  persist();
  updateCartUI();
}

function removeFromCart(id){
  state.cart = state.cart.filter(ci=>ci.id!==id);
  persist();
  updateCartUI();
}

function changeQty(id, delta){
  const it = state.cart.find(ci=>ci.id===id);
  if(!it) return;
  it.qty += delta;
  if(it.qty<=0){ removeFromCart(id); return; }
  persist();
  updateCartUI();
}

function cartItemsDetailed(){
  return state.cart.map(ci=>{
    const item = MENU.find(m=>m.id===ci.id);
    return {...ci, ...item, lineTotal: +(item.price * ci.qty).toFixed(2)};
  });
}

function persist(){
  localStorage.setItem('cart', JSON.stringify(state.cart));
}

function updateCartCount(){
  byId('cartCount').textContent = state.cart.reduce((a,c)=>a+c.qty, 0);
}

function updateCartUI(){
  updateCartCount();

  const container = byId('cartItems');
  const drawerItems = byId('drawerItems');
  container.innerHTML = '';
  drawerItems.innerHTML = '';

  cartItemsDetailed().forEach(ci=>{
    const line = cartLine(ci);
    const line2 = cartLine(ci);
    container.appendChild(line);
    drawerItems.appendChild(line2);
  });

  updateTotals();
}

function cartLine(ci){
  const el = document.createElement('div');
  el.className = 'cart-item';
  el.innerHTML = `
    <div class="grow">
      <h4>${ci.name[state.lang]}</h4>
      <div class="row">${ci.desc[state.lang]}</div>
    </div>
    <div class="qty">
      <button class="icon-btn" aria-label="Decrease">–</button>
      <span>${ci.qty}</span>
      <button class="icon-btn" aria-label="Increase">+</button>
    </div>
    <div class="line-total">${fmtCurrency(ci.lineTotal)}</div>
    <button class="icon-btn" aria-label="Remove">✕</button>
  `;
  const [dec, , inc] = el.querySelectorAll('.qty button');
  const removeBtn = el.querySelectorAll('.icon-btn')[2];
  inc.addEventListener('click', ()=>changeQty(ci.id, +1));
  dec.addEventListener('click', ()=>changeQty(ci.id, -1));
  removeBtn.addEventListener('click', ()=>removeFromCart(ci.id));
  return el;
}

// Totals
const MIN_DELIVERY = 15;
const DELIVERY_FEE = 3.5;
const PICKUP_DISCOUNT = 0.10; // 10%

function calcTotals(){
  const items = cartItemsDetailed();
  const subtotal = items.reduce((a,c)=>a+c.lineTotal, 0);
  const isPickup = state.orderType === 'pickup';
  const pickupDiscount = isPickup ? subtotal * PICKUP_DISCOUNT : 0;
  const needsFee = !isPickup && subtotal < 35 && subtotal > 0;
  const deliveryFee = (!isPickup) ? (needsFee ? DELIVERY_FEE : 0) : 0;
  const total = Math.max(0, subtotal - pickupDiscount + deliveryFee);
  return {subtotal, pickupDiscount, deliveryFee, total};
}

function updateTotals(){
  const {subtotal, pickupDiscount, deliveryFee, total} = calcTotals();
  byId('subtotal').textContent = fmtCurrency(subtotal);
  byId('total').textContent = fmtCurrency(total);
  byId('pickupDiscountRow').hidden = !(pickupDiscount>0);
  byId('pickupDiscount').textContent = '–' + fmtCurrency(pickupDiscount);
  byId('deliveryFeeRow').hidden = !(deliveryFee>0);
  byId('deliveryFee').textContent = fmtCurrency(deliveryFee);
  byId('drawerSubtotal').textContent = fmtCurrency(subtotal);
  byId('minOrderNote').hidden = (state.orderType==='pickup');
}

// === Delivery form toggle ===
function setOrderType(type){
  state.orderType = type;
  const address = byId('addressFields');
  const isDelivery = type === 'delivery';
  if(isDelivery){
    address.classList.remove('hidden');
    address.setAttribute('aria-hidden','false');
  }else{
    address.classList.add('hidden');
    address.setAttribute('aria-hidden','true');
  }
  updateTotals();
}

// === Place order ===
function placeOrder(){
  const name = byId('customerName').value.trim();
  const phone = byId('customerPhone').value.trim();
  if(!name || !phone){
    alert('Bitte Name & Telefon angeben / Please enter name & phone.');
    return;
  }
  if(state.orderType==='delivery'){
    const street = byId('street').value.trim();
    const zip = byId('zip').value.trim();
    const city = byId('city').value.trim();
    if(!street || !zip || !city){
      alert('Bitte Adresse für Lieferung ausfüllen / Please fill the delivery address.');
      return;
    }
  }
  // Minimum check for delivery
  const totals = calcTotals();
  if(state.orderType==='delivery' && totals.subtotal < MIN_DELIVERY){
    alert(t('msg.min_order'));
    return;
  }
  // Build mailto (static sites friendly)
  const items = cartItemsDetailed().map(ci=>`${ci.qty}× ${ci.name[state.lang]} – ${fmtCurrency(ci.lineTotal)}`).join('%0D%0A');
  const orderInfo = [
    `Typ: ${state.orderType==='pickup' ? (state.lang==='it'?'Ritiro':state.lang==='en'?'Pickup':'Abholung') : (state.lang==='it'?'Consegna':state.lang==='en'?'Delivery':'Lieferung')}`,
    `Zwischensumme: ${fmtCurrency(totals.subtotal)}`,
    state.orderType==='pickup' ? `Abholrabatt: -${fmtCurrency(totals.pickupDiscount)}` : `Liefergebühr: ${fmtCurrency(totals.deliveryFee)}`,
    `Gesamt: ${fmtCurrency(totals.total)}`
  ].join('%0D%0A');

  const addr = state.orderType==='delivery'
    ? `%0D%0AAdresse: ${encodeURIComponent(byId('street').value)}, ${encodeURIComponent(byId('zip').value)} ${encodeURIComponent(byId('city').value)}`
    : '';

  const notes = byId('notes').value ? `%0D%0ANotiz: ${encodeURIComponent(byId('notes').value)}` : '';

  const subject = encodeURIComponent(t('msg.order_mail_subject'));
  const body = `Name: ${encodeURIComponent(name)}%0D%0ATelefon: ${encodeURIComponent(phone)}${addr}${notes}%0D%0A%0D%0A${encodeURIComponent(t('msg.order_mail_body'))}:%0D%0A${items}%0D%0A%0D%0A${orderInfo}`;

  // Swap with your restaurant email
  window.location.href = `mailto:bestellung@example.com?subject=${subject}&body=${body}`;
}

// === PayPal Buttons (optional) ===
window.addEventListener('load', ()=>{
  if(window.paypal && document.getElementById('paypal-button-container')){
    paypal.Buttons({
      style:{layout:'horizontal'},
      createOrder: (data, actions)=>{
        const { total } = calcTotals();
        return actions.order.create({
          purchase_units: [{
            amount: { value: total.toFixed(2), currency_code:'EUR' },
            description: 'Ristorante Napoli Online Order'
          }]
        });
      },
      onApprove: (data, actions)=>actions.order.capture().then(function(){
        alert('Grazie! Payment received.');
      })
    }).render('#paypal-button-container');
  }
});

// === Forms (contact & reservation) ===
byId('contactForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  byId('responseMsg').textContent = t('msg.contact_success');
  e.target.reset();
});

byId('reservationForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  byId('reservationMsg').textContent = t('msg.reservation_success');
  e.target.reset();
});

// === Nav / Cart Drawer ===
byId('menuToggle').addEventListener('click', ()=>{
  const nav = document.getElementById('mainNav');
  const expanded = nav.classList.toggle('open');
  byId('menuToggle').setAttribute('aria-expanded', expanded);
});

const cartDrawer = byId('cartDrawer');
byId('openCart').addEventListener('click', ()=> cartDrawer.hidden = false);
byId('closeCart').addEventListener('click', ()=> cartDrawer.hidden = true);
byId('cartBackdrop').addEventListener('click', ()=> cartDrawer.hidden = true);
byId('drawerToDelivery').addEventListener('click', ()=>{
  cartDrawer.hidden = true;
  document.getElementById('delivery').scrollIntoView({behavior:'smooth'});
});

// cart controls
byId('clearCart').addEventListener('click', ()=>{
  state.cart = [];
  persist();
  updateCartUI();
});

byId('placeOrder').addEventListener('click', placeOrder);

// order type toggle
document.querySelectorAll('input[name="orderType"]').forEach(r=>{
  r.addEventListener('change', (e)=> setOrderType(e.target.value));
});

// language switch
const langSelect = byId('langSelect');
langSelect.value = state.lang;
langSelect.addEventListener('change', (e)=>{
  state.lang = e.target.value;
  localStorage.setItem('lang', state.lang);
  renderMenu();
  applyI18n();
});

// year
byId('year').textContent = new Date().getFullYear();

// initial render
renderMenu();
applyI18n();
updateCartUI();
setOrderType('pickup');
